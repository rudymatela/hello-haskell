#!/bin/bash

set -e

START_MARKER="^matrix:$"
END_MARKER="^  - ghc: '7.10'$"

errxit() {
	echo "$0: $@" > /dev/stderr
	exit 1
}

src="`dirname $0`/.travis.yml"
[ -f "$src" ] || errxit "could not find source .travis.yml file $src"

dst="$1"
[ -n "$dst" ] || errxit "must provide destination directory"
[ -d "$dst" ] || errxit "could not find destination directory $dst"

dst="$dst/.travis.yml"
[ -f "$dst" ] || errxit "could not find destination .travis.yml file $dst"

grep -q "$START_MARKER" "$dst" || errxit "could not find start marker"
grep -q "$END_MARKER"   "$dst" || errxit "could not find end marker"

which -q sponge >/dev/null 2>/dev/null || errxit "could not find sponge program from moreutils"

grep -B 5040 "$START_MARKER" "$dst" | head -n -1                  >$dst.new
grep -A 5040 "$START_MARKER" "$src" | grep -B 5040 "$END_MARKER" >>$dst.new
grep -A 5040 "$END_MARKER"   "$dst" | tail -n +2                 >>$dst.new
mv $dst.new $dst
